@page "/EditLicenses"
@* @attribute [Authorize(Policy = "PermitionPolicy", AuthenticationSchemes = "a")] Policy="PermitionPolicy" Resource=(EPermition.Aplication,EAccess.ReadOnly,String.Empty)*@
@inject PobytneService service

<PageTitle>EditLicense</PageTitle>
<AuthorizeView>
    <Authorized>

    <div class="row h-100">
        <div class="col-lg-3 mh-100 overflow-hidden">
            <HxTreeView TItem="IDirectory"
                        SelectedItemChanged="OnSelect"
                        Items="@fileSystem"
                        CssClass="p-3 card floating-card h-auto"
                        ItemTitleSelector="@(p => p.Name)"
                        ItemIconSelector="@(p => p.Icon)"
                        ItemInitialExpandedSelector=@(p => p.Name=="Pobytne licence")
                        ItemChildrenSelector="@(p => p.SubDirectories)" />
        </div>
        <div class="col-lg-9 mh-100 overflow-hidden">
            <ListCustom ListTitle="@listTitle" ListItems=@listOfItems selectedItem=selectedItem selectedItemChanged=OnItemSelect EventNewItem="OnNewItem"></ListCustom>
        </div>
    </div>
		    <FormModal formItem="formItem" @ref=formModal OnSuccessRequest="OnSuccessRequestHandler"></FormModal>
	    </Authorized>
	<NotAuthorized>
		JSTE V NOACCESS MODU PRO  PRISTUP - APLICATION
	</NotAuthorized>
</AuthorizeView>
<style>
    .scrollable-table-container {
		max-height: 80svh;
		overflow: auto;
	}
</style>
@code {
    [CascadingParameter]
    private ModuleWorkplace moduleWorkspace { get; set; } = default!;

    private IDirectory? selectedDirectory;
    private IListItem? selectedItem;
    private IListItem? formItem;
    private List<IListItem>? listOfItems;
    private List<Directory> fileSystem = new();
    private FormModal? formModal;

    private string listTitle
    {
        get
        {
            switch (selectedDirectory)
            {
                case Directory d:
                    return "Počet licencí";
                case LicenseDir l:
                    return "Počet modulů";
                case UserDir u:
                    return "Počet uživatelů";
                case ModuleDir m:
                    return "Počet oprávnění";
                default:
                    return string.Empty;
            }
        }
    }

    private async Task OnSelect(IDirectory e)
    {
        this.selectedDirectory = e;
        if (selectedDirectory is not null)
        {
            await selectedDirectory.OnSelect();
            listOfItems = selectedDirectory.ItemsList;            
        }
    }
    private async Task OnItemSelect(IListItem i)
    {
        if(i is not null && formModal is not null)
        {
            formItem = i;
            await formModal.UpdateForm();            
        }
        selectedItem = null;
    }
    protected override async Task OnInitializedAsync()
    {
        moduleWorkspace.Id = -1;
        fileSystem = new List<Directory>() { new Directory(service, "Pobytné licence") };
        await fileSystem[0].OnSelect();
    }
    private async Task OnNewItem()
    {
        if(selectedDirectory is not null && formModal is not null)
        {
            formItem = selectedDirectory.GetNew();
            await formModal.InsertForm();            
        }
    }
    private async Task OnSuccessRequestHandler()
    {
        if (selectedDirectory is not null)
        {
            await selectedDirectory.Refresh();
            await OnSelect(selectedDirectory);            
        }
        StateHasChanged();
    }
    //TODO: Delete
    //TODO: Opraveneni k editu licenci
}