@inject IJSRuntime js
<HxListLayout TFilterModel="HxListLayout.NoFilter" CssClass="floating-card">
        <TitleTemplate>
            @ListTitle <HxBadge Color="ThemeColor.Light" TextColor="ThemeColor.Dark" CssClass="ms-1">@ListItems?.Count</HxBadge>
        </TitleTemplate>
        <SearchTemplate>
        <HxCheckbox @bind-Value="ShowActive" @bind-Value:after="gridComponent.RefreshDataAsync" Text="Zobrazit pouze aktivní" Enabled="ListItems is not null"/>
        <HxInputText Placeholder="Hledat" Type="InputType.Search" @bind-Value="SearchText" @bind-Value:after="gridComponent.RefreshDataAsync" Enabled="ListItems is not null" />
        </SearchTemplate>
        <CommandsTemplate>
            @if(Editable){
                <HxButton Text="Nová položka" Color="ThemeColor.Primary" Icon="BootstrapIcon.PlusLg" OnClick="NewItemClicked" Enabled="ListItems is not null" />
            }
        </CommandsTemplate>
    @* TODO:Infinite scroll LAZY-LOADING *@
    <DataTemplate>
        <HxGrid @ref="gridComponent" 
            TItem="IListItem" 
            Responsive="true" 
            DataProvider="LoadDataItems" 
            SelectedDataItemChanged="HandleSelectedDataItemChanged"
            SelectedDataItem="selectedItem" 
            ContentNavigationMode="GridContentNavigationMode.InfiniteScroll" 
            TableContainerCssClass="scrollable-table-container"
            HeaderRowCssClass="sticky-top"
            ItemRowHeight="20">
            <Columns>
                <HxGridColumn HeaderText="Id" ItemTextSelector="@(item => item.Id.ToString())" IsDefaultSortColumn=false/>
                <HxGridColumn HeaderText="Název" ItemTextSelector="@(item => item.Name)" />
                <HxGridColumn HeaderText="Popis" ItemTextSelector="@(item => item.Description)"/>
                <HxGridColumn HeaderText="Poslední úprava" ItemTextSelector="@(item => item.CreationDate.ToString())"/>

                @MenuGridColumn                
  
            </Columns>
        </HxGrid>
    </DataTemplate>
</HxListLayout>
@code {
    [Parameter]
    public RenderFragment? MenuGridColumn { get; set; }
    [Parameter]
    [EditorRequired]
    public List<IListItem>? ListItems 
    {
        get
        {
            if(ShowActive)
                return listItems?.Where(l => l.Active).ToList();
            return listItems;
        }
        set
        {
            listItems = value;
            SearchText = "";
        } 
    }
    private List<IListItem>? listItems;
    [Parameter]
    public IListItem? selectedItem { get; set; }
    private HxGrid<IListItem> gridComponent = new();
    [Parameter]
    public EventCallback<IListItem?> selectedItemChanged { get; set; }
    [Parameter]
    public EventCallback EventNewItem{ get; set; }
    [Parameter]
    public bool Editable { get; set; } = true;
    [Parameter]
    public bool LazyLoading { get; set; } = false;
    [Parameter]
    public EventCallback<(int,int)> LoadMore { get; set; }
    [Parameter]
    public int TotalCount {get;set;}
    [Parameter]
    [EditorRequired]
    public required string ListTitle{ get; set; } 

    private bool ShowActive = false;
    private string SearchText = string.Empty;

    private async Task<GridDataProviderResult<IListItem>> LoadDataItems(GridDataProviderRequest<IListItem> request)
    {
        IEnumerable<IListItem>? result = ListItems?.Where(c => c.Name.Contains(SearchText, StringComparison.OrdinalIgnoreCase)).ToList();

        await Task.Delay(500);

        Console.WriteLine($"startIndex: {request.StartIndex} Count: {request.Count}");

        return new GridDataProviderResult<IListItem>()
			{
				Data = result?.Skip(request.StartIndex).Take(request.Count??15),
				TotalCount = result?.Count()
			};
    }

    protected async override Task OnParametersSetAsync()
    {
        base.OnParametersSet();
        await gridComponent.RefreshDataAsync();
    }

    private async Task HandleSelectedDataItemChanged(IListItem selection)
    {
        selectedItem = selection;
        await selectedItemChanged.InvokeAsync(selectedItem);
        // await dataItemEditComponent.ShowAsync();
    }


    private async Task NewItemClicked()// async
    {
        //currentItem = new();
        // await dataItemEditComponent.ShowAsync();
        await EventNewItem.InvokeAsync();
    }
}