@inject IJSRuntime js
<HxListLayout TFilterModel="HxListLayout.NoFilter" CssClass="floating-card">
        <TitleTemplate>
            @ListTitle <HxBadge Color="ThemeColor.Light" TextColor="ThemeColor.Dark" CssClass="ms-1">@ListItems?.Count</HxBadge>
        </TitleTemplate>
        <SearchTemplate>
        <HxCheckbox @bind-Value="ShowAll" @bind-Value:after="gridComponent.RefreshDataAsync" Text="Zobrazit vše" Enabled="ListItems is not null"/>
        <HxInputText Placeholder="Hledat" Type="InputType.Search" @bind-Value="SearchText" @bind-Value:after="gridComponent.RefreshDataAsync" Enabled="ListItems is not null" />
        </SearchTemplate>
        <CommandsTemplate>
            @if(Editable){
                <HxButton Text="Nová položka" Color="ThemeColor.Primary" Icon="BootstrapIcon.PlusLg" OnClick="NewItemClicked" Enabled="ListItems is not null" />
            }
        </CommandsTemplate>
    @* TODO:Infinite scroll LAZY-LOADING *@
    <DataTemplate>
        <HxGrid @ref="gridComponent" 
            TItem="IListItem" 
            Responsive="true" 
            DataProvider="LoadDataItems" 
            SelectedDataItemChanged="HandleSelectedDataItemChanged"
            SelectedDataItem="selectedItem" 
            ContentNavigationMode="GridContentNavigationMode.InfiniteScroll" 
            TableContainerCssClass="scrollable-table-container"
            HeaderRowCssClass="sticky-top">
            <Columns>
                <HxGridColumn HeaderText="Id" ItemTextSelector="@(item => item.Id.ToString())" SortKeySelector="@(item => item.Id)" IsDefaultSortColumn="false" />
                <HxGridColumn HeaderText="Název" ItemTextSelector="@(item => item.Name)" SortKeySelector="@(item => item.Name)" />
                <HxGridColumn HeaderText="Popis" ItemTextSelector="@(item => item.Description)" SortKeySelector="@(item => item.Description)" />
                <HxGridColumn HeaderText="Poslední úprava" ItemTextSelector="@(item => item.CreationDate.ToString())" SortKeySelector="@(item => item.CreationDate)" />
                @if (Editable)
                {
                    <HxContextMenuGridColumn Context="item">
					    <HxButton Icon="@BootstrapIcon.Trash" style="color:red; padding: 0px;" Color="ThemeColor.Link" OnClick="async ()=> await DeleteItemClicked(item)" />
				    </HxContextMenuGridColumn>                    
                }
            </Columns>
        </HxGrid>
    </DataTemplate>
</HxListLayout>
@code {
    [Parameter]
    [EditorRequired]
    public List<IListItem>? ListItems 
    {
        get
        {
            if(ShowAll)
                return listItems;
            return listItems?.Where(l => l.Active).ToList();
        }
        set
        {
            listItems = value;
            SearchText = "";
        } 
    }
    private List<IListItem>? listItems;
    [Parameter]
    public IListItem? selectedItem { get; set; }
    private HxGrid<IListItem> gridComponent = new();
    [Parameter]
    public EventCallback<IListItem?> selectedItemChanged { get; set; }
    [Parameter]
    public EventCallback EventNewItem{ get; set; }
    [Parameter]
    public bool Editable { get; set; } = true;
    [Parameter]
    [EditorRequired]
    public required string ListTitle{ get; set; } 
    private bool ShowAll = false;
    private string SearchText = string.Empty;

    private Task<GridDataProviderResult<IListItem>> LoadDataItems(GridDataProviderRequest<IListItem> request)
    {
  //       string debugOutput = $"Requesting data: StartIndex={request.StartIndex}, Count={request.Count}";
		// StateHasChanged();

		// await Task.Delay(500);  // simulate server delay in demo (do not put this in your code)

		// return new GridDataProviderResult<IListItem>()
		// 	{
		// 		Data = await DemoDataService.GetEmployeesDataFragmentAsync(request.StartIndex, request.Count, request.CancellationToken),
		// 		TotalCount = await DemoDataService.GetEmployeesCountAsync(request.CancellationToken)
		// 	};
        IEnumerable<IListItem>? result = ListItems?.Where(c => c.Name.Contains(SearchText, StringComparison.OrdinalIgnoreCase)).ToList();

        return Task.FromResult(request.ApplyTo(result));
    }

    protected async override Task OnParametersSetAsync()
    {
        base.OnParametersSet();
        await gridComponent.RefreshDataAsync();
    }

    private async Task DeleteItemClicked(IListItem editableCultureInfo)
    {
        ListItems?.Remove(editableCultureInfo);
    await gridComponent.RefreshDataAsync();
    }

    private async Task HandleSelectedDataItemChanged(IListItem selection)
    {
        selectedItem = selection;
        await selectedItemChanged.InvokeAsync(selectedItem);
        // await dataItemEditComponent.ShowAsync();
    }


    private async Task NewItemClicked()// async
    {
        //currentItem = new();
        // await dataItemEditComponent.ShowAsync();
        await EventNewItem.InvokeAsync();
    }
}