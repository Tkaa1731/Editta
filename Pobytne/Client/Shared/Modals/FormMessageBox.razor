@inject IJSRuntime js
@inject PobytneService service

<HxModal @ref="myModal" Backdrop="ModalBackdrop.Static" Size="ModalSize.Large" OnClosed="HandleHideClick">
    <HeaderTemplate>
        <h2 class=@headerStyle>@headerText</h2>
    </HeaderTemplate>
    <BodyTemplate>
        @switch (formItem)
        {
            case User user:
                @if(user.AccessPermition is null || user.AccessPermition.Count == 0)
                {
                    <UserForm user=user formType=formType OnValidSubmit="Request" ></UserForm>
                    break;
                }
                <PermitionForm permition="user.AccessPermition.First()" formType="formType" OnValidSubmit="Request"></PermitionForm>
                break;
            case Module module:
                <ModuleForm module=module formType=formType OnValidSubmit="Request"></ModuleForm>
                break;
            case License license:
                <LicenseForm license=license formType=formType OnValidSubmit="Request"></LicenseForm>
                break;
            case Client client:
                <ClientForm client="client" formType="formType" OnValidSubmit="Request"/>
                break;
        }
    </BodyTemplate>
</HxModal>

@code
{
    [CascadingParameter]
    private ModuleWorkplace moduleWorkspace { get; set; } = default!;

    [Parameter]
    public EventCallback OnSuccessRequest{ get; set; }
    [Parameter]
    [EditorRequired]
    public required IListItem formItem{ get; set; }
    private EForm formType;

    public HxModal myModal = new();

    private string headerText = "";
    private string headerStyle = "";

    public async Task UpdateForm()
    {
        var t = formItem;
        formType = EForm.Update;
        await myModal.ShowAsync();
    }
    public async Task InsertForm()
    {
        var t = formItem;
        formType = EForm.Insert;
        await myModal.ShowAsync();
    }
    private async Task HandleHideClick()
    {
        headerText = "";
        headerStyle = "";
        await myModal.HideAsync();
    }

    private async Task  CompleteReq<T>(EForm e,T obj)
    {
        object? response = null;
        if(e == EForm.Update)
            response = await service.UpdateAsync(obj, moduleWorkspace.Id);
        else if(e == EForm.Insert)
            response = await service.InsertAsync(obj, moduleWorkspace.Id);

        if (response is null || response is ErrorResponse)
        {
            headerText = "FAIL";
            //ERROR occured
        }
        else
        {
            headerText = "SUCCESS";
            headerStyle = "text-success";
            await OnSuccessRequest.InvokeAsync();            
        }
        StateHasChanged();// rerender componennt
        return;

    }
    private async Task Request(EForm request)
    {
        if(formItem is not null)
        {   
            headerStyle = "text-danger";

            formItem.CreationDate = DateTime.Now;
            formItem.CreationUserId = moduleWorkspace.UserId;

            switch (formItem)
            {
                case User user:
                    if (user.AccessPermition is null)
                        await CompleteReq(request, user);
                    else
                    {
                        var permition = user.AccessPermition.First();// je jenom jedna, jedna konkretniho modulu
                        permition.CreationDate = user.CreationDate;// kopie nastavenzch hodnot
                        permition.CreationUserId = user.CreationUserId;
                        await CompleteReq(request,permition);
                    }
                    break;
                case Module module:
                    await CompleteReq(request, module);
                    break;
                case License license:
                    await CompleteReq(request, license);
                    break;
                default:
                    await js.InvokeVoidAsync("alert", "neni implementovano");
                    break;
            }

            await Task.Delay(1000);

            await HandleHideClick();
        }
    }
//TODO: zobrazovani modulu nefingije, zobrazuje vzdy predposledni
}